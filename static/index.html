<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puter Python Manager - æœ¬åœ°AIè´¦å·ç®¡ç†å¹³å°</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Puter.js (Async for max performance) -->
    <script src="https://js.puter.com/v2/" async></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container-fluid {
            max-width: 1800px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 25px;
            margin-bottom: 20px;
            transition: transform 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-card:hover {
            transform: translateY(-5px);
        }

        .icon-box {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            margin-right: 10px;
        }

        .icon-rocket {
            background: var(--primary-gradient);
            color: white;
        }

        .icon-config {
            background: var(--secondary-gradient);
            color: white;
        }

        .icon-lock {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .icon-chart {
            background: var(--success-gradient);
            color: white;
        }

        .icon-test {
            background: var(--warning-gradient);
            color: white;
        }

        .icon-debug {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .api-box {
            background: #2d3436;
            color: #00ff88;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            word-break: break-all;
            border-left: 4px solid #667eea;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-running {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            background: #1e272e;
            color: #00ff88;
            padding: 15px;
            border-radius: 8px;
        }

        .btn-gradient-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            font-weight: 600;
        }

        .btn-gradient-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a3d9c 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .form-control,
        .form-select {
            border: 2px solid #dfe6e9;
            border-radius: 8px;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: #636e72;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <nav class="navbar navbar-expand-lg navbar-light glass-card mb-4">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold text-primary" href="#">
                    <span class="icon-box icon-rocket">âš¡</span>
                    Puter Python Manager
                </a>
                <div class="d-flex align-items-center">
                    <span class="badge bg-dark me-2">v2.0</span>
                    <div class="d-flex align-items-center">
                        <span class="me-2" id="systemStatus">ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸</span>
                        <div class="spinner-border spinner-border-sm text-primary d-none" id="loadingSpinner"></div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="row g-4">
            <!-- å·¦ä¾§ä¾§è¾¹æ  -->
            <div class="col-lg-3">
                <!-- è´¦å·ç®¡ç†å¡ç‰‡ -->
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="fas fa-users me-2"></i>
                            è´¦å·ç®¡ç†
                            <span class="badge bg-secondary ms-2" id="accountsCount">0</span>
                        </h5>
                        <button class="btn btn-sm btn-gradient-primary" id="addAccountBtn">
                            <i class="fas fa-plus"></i> æ·»åŠ 
                        </button>
                    </div>

                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>è´¦å·</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="accountsTable">
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-3">
                                        åŠ è½½è´¦å·åˆ—è¡¨...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="launchBrowserBtn">
                            <i class="fas fa-plug me-1"></i> è¿æ¥ Puter è´¦å·
                        </button>
                        <button class="btn btn-sm btn-outline-success w-100" id="refreshAllBtn">
                            <i class="fas fa-sync-alt me-1"></i> åˆ·æ–°æ‰€æœ‰Cookie
                        </button>
                    </div>
                </div>

                <!-- å¿«é€Ÿé…ç½® -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-cogs me-2"></i>
                        å¿«é€Ÿé…ç½®
                    </h5>

                    <div class="mb-3">
                        <label class="form-label fw-bold">API Key:</label>
                        <input type="password" class="form-control" id="apiKeyInput" value="1">
                        <small class="text-muted">ç”¨äºä¿æŠ¤APIè®¿é—®</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">æœ¬åœ°æœåŠ¡:</label>
                        <div class="api-box">http://<span id="localHost">127.0.0.1</span>:<span
                                id="localPort">8000</span></div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Puter.js URL:</label>
                        <input type="text" class="form-control" id="puterJsUrl" value="https://js.puter.com/v2/">
                    </div>

                    <button class="btn btn-gradient-primary w-100" id="saveConfigBtn">
                        <i class="fas fa-save me-1"></i> ä¿å­˜é…ç½®
                    </button>
                </div>

                <!-- ç³»ç»ŸçŠ¶æ€ -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-heartbeat me-2"></i>
                        ç³»ç»ŸçŠ¶æ€
                    </h5>

                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">æœåŠ¡çŠ¶æ€:</small>
                            <span class="badge bg-success" id="serviceStatus">è¿è¡Œä¸­</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">æ€»è´¦å·æ•°:</small>
                            <span id="totalAccounts">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">æ´»è·ƒè´¦å·:</small>
                            <span id="activeAccounts">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">APIè¯·æ±‚:</small>
                            <span id="apiRequestCount">0</span>
                        </div>
                    </div>

                    <div class="progress mb-1" style="height: 8px;">
                        <div class="progress-bar bg-info" id="memoryUsage" style="width: 30%"></div>
                    </div>
                    <small class="text-muted d-block text-center">å†…å­˜ä½¿ç”¨: <span id="memoryText">30%</span></small>
                </div>
            </div>

            <!-- ä¸­é—´ä¸»å†…å®¹ -->
            <div class="col-lg-6">
                <!-- Puter.js AIåŠŸèƒ½ -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <span class="icon-box icon-rocket">ğŸš€</span>
                        Puter.js AI åŠŸèƒ½
                    </h5>

                    <ul class="nav nav-tabs mb-3" id="aiTabs">
                        <li class="nav-item">
                            <button class="nav-link active" id="image-tab" data-bs-toggle="tab"
                                data-bs-target="#imageTab">
                                <i class="fas fa-image me-1"></i> å›¾åƒç”Ÿæˆ
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chatTab">
                                <i class="fas fa-comment me-1"></i> AIèŠå¤©
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="edit-tab" data-bs-toggle="tab" data-bs-target="#editTab">
                                <i class="fas fa-edit me-1"></i> å›¾åƒç¼–è¾‘
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- å›¾åƒç”Ÿæˆé€‰é¡¹å¡ -->
                        <div class="tab-pane fade show active" id="imageTab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">æç¤ºè¯:</label>
                                <textarea class="form-control" id="imagePrompt" rows="3"
                                    placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„å›¾åƒ...">A serene Japanese garden with cherry blossoms and a koi pond</textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">æ¨¡å‹:</label>
                                    <select class="form-select" id="imageModel">
                                        <option value="black-forest-labs/FLUX.2-pro">FLUX.2 Pro (æ¨è)</option>
                                        <option value="black-forest-labs/FLUX.2-max">FLUX.2 Max (æœ€é«˜è´¨é‡)</option>
                                        <option value="black-forest-labs/FLUX.1-schnell">FLUX.1 Schnell (å¿«é€Ÿ)</option>
                                        <option value="black-forest-labs/FLUX.2-flex">FLUX.2 Flex (å¯å®šåˆ¶)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">å°ºå¯¸:</label>
                                    <select class="form-select" id="imageSize">
                                        <option value="512x512">512x512</option>
                                        <option value="768x768" selected>768x768</option>
                                        <option value="1024x1024">1024x1024</option>
                                        <option value="768x1024">768x1024 (è‚–åƒ)</option>
                                        <option value="1024x768">1024x768 (é£æ™¯)</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-gradient-primary w-100" id="generateImageBtn">
                                <i class="fas fa-magic me-1"></i> ç”Ÿæˆå›¾åƒ
                            </button>

                            <div class="mt-3 text-center">
                                <div class="spinner-border text-primary d-none" id="imageSpinner"></div>
                                <div id="imageResult" class="mt-3"></div>
                            </div>
                        </div>

                        <!-- AIèŠå¤©é€‰é¡¹å¡ -->
                        <div class="tab-pane fade" id="chatTab">
                            <div class="mb-3">
                                <label class="form-label fw-bold">æ¶ˆæ¯:</label>
                                <textarea class="form-control" id="chatMessage" rows="3"
                                    placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯...">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</textarea>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">æ¨¡å‹:</label>
                                    <select class="form-select" id="chatModel">
                                        <option value="gpt-4o-mini">GPT-4o Mini (æ¨è)</option>
                                        <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                                        <option value="gpt-5-nano">GPT-5 Nano (Experimental)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">æ¨¡å¼:</label>
                                    <select class="form-select" id="chatMode">
                                        <option value="stream">æµå¼å“åº”</option>
                                        <option value="complete">å®Œæ•´å“åº”</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-gradient-primary w-100" id="sendChatBtn">
                                <i class="fas fa-paper-plane me-1"></i> å‘é€æ¶ˆæ¯
                            </button>

                            <div class="mt-3">
                                <div class="log-container" id="chatResponse" style="height: 200px;">
                                    ç­‰å¾…å“åº”...
                                </div>
                            </div>
                        </div>

                        <!-- å›¾åƒç¼–è¾‘é€‰é¡¹å¡ -->
                        <div class="tab-pane fade" id="editTab">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                å›¾åƒç¼–è¾‘åŠŸèƒ½éœ€è¦æä¾›åŸå§‹å›¾åƒURLå’Œç¼–è¾‘æç¤ºè¯
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">å›¾åƒURL:</label>
                                <input type="text" class="form-control" id="editImageUrl"
                                    placeholder="https://example.com/image.jpg"
                                    value="https://assets.puter.site/doge.jpeg">
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">ç¼–è¾‘æŒ‡ä»¤:</label>
                                <textarea class="form-control" id="editPrompt" rows="3"
                                    placeholder="æè¿°å¦‚ä½•ç¼–è¾‘å›¾åƒ...">Draw an anime style version of this image.</textarea>
                            </div>

                            <button class="btn btn-gradient-primary w-100" id="editImageBtn">
                                <i class="fas fa-paint-brush me-1"></i> ç¼–è¾‘å›¾åƒ
                            </button>

                            <div class="mt-3 text-center">
                                <div class="spinner-border text-primary d-none" id="editSpinner"></div>
                                <div id="editResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœåŠ¡çŠ¶æ€å’Œæ—¥å¿— -->
                <div class="glass-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            æœåŠ¡çŠ¶æ€ä¸æ—¥å¿—
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" id="clearLogsBtn">
                                <i class="fas fa-trash"></i> æ¸…ç©º
                            </button>
                            <button class="btn btn-outline-secondary" id="pauseLogsBtn">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <span class="stat-number" id="requestCount">0</span>
                                <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <span class="stat-number" id="successCount">0</span>
                                <div class="stat-label">æˆåŠŸ</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <span class="stat-number" id="errorCount">0</span>
                                <div class="stat-label">å¤±è´¥</div>
                            </div>
                        </div>
                    </div>

                    <div class="log-container" id="liveLogs">
                        [ç³»ç»Ÿ] æ­£åœ¨åŠ è½½æ—¥å¿—...
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ä¾§è¾¹æ  -->
            <div class="col-lg-3">
                <!-- APIç«¯ç‚¹ -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-code me-2"></i>
                        API ç«¯ç‚¹
                    </h5>

                    <div class="mb-2">
                        <div class="api-box mb-1">
                            <small class="text-info">POST</small> /v1/chat/completions
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /v1/models
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">GET</small> /api/accounts
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">POST</small> /api/account/create
                        </div>
                        <div class="api-box mb-1">
                            <small class="text-info">POST</small> /api/account/{id}/launch-browser
                        </div>
                        <div class="api-box">
                            <small class="text-info">GET</small> /api/system/status
                        </div>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">API Key:</small>
                        <code class="small d-block bg-light p-1 rounded">1 (æˆ–é…ç½®ä¸­ä¿®æ”¹)</code>
                    </div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        ç³»ç»Ÿä¿¡æ¯
                    </h5>

                    <div class="small">
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ç‰ˆæœ¬:</span>
                            <span>v2.0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">å¯åŠ¨æ—¶é—´:</span>
                            <span id="uptime">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Python:</span>
                            <span id="pythonVersion">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ä¸»æœº:</span>
                            <span id="hostName">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">å·¥ä½œç›®å½•:</span>
                            <span class="text-truncate" style="max-width: 150px;" id="workingDir">--</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">æ•°æ®ç›®å½•:</span>
                            <span class="text-truncate" style="max-width: 150px;" id="dataDir">--</span>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿé“¾æ¥ -->
                <div class="glass-card">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="fas fa-link me-2"></i>
                        å¿«é€Ÿé“¾æ¥
                    </h5>

                    <div class="row g-2">
                        <div class="col-6">
                            <a href="/docs" target="_blank" class="btn btn-outline-primary w-100">
                                <i class="fas fa-book me-1"></i> APIæ–‡æ¡£
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="https://docs.puter.com/" target="_blank" class="btn btn-outline-info w-100">
                                <i class="fas fa-external-link-alt me-1"></i> Puteræ–‡æ¡£
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="https://puter.com" target="_blank" class="btn btn-outline-success w-100">
                                <i class="fas fa-globe me-1"></i> Puterç½‘ç«™
                            </a>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-warning w-100" id="restartServiceBtn">
                                <i class="fas fa-redo me-1"></i> é‡å¯æœåŠ¡
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="mt-4 pt-3 border-top text-center">
            <small class="text-white">
                <i class="fas fa-exclamation-circle me-1"></i>
                Puter Python Manager - æœ¬åœ°AIè´¦å·ç®¡ç†å¹³å° |
                æœåŠ¡åœ°å€: <code
                    class="text-white">http://<span id="footerHost">127.0.0.1</span>:<span id="footerPort">8000</span></code>
                |
                æœ€åæ›´æ–°: <span id="updateTime">--:--:--</span>
            </small>
        </footer>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.1/js/bootstrap.bundle.min.js"></script>

    <!-- ä¸»JavaScript -->
    <script>
        // å…¨å±€çŠ¶æ€
        let systemState = {
            logs: [],
            accounts: [],
            isLogPaused: false,
            autoScroll: true
        };

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            initializeSystem();
            loadSystemInfo();
            loadAccounts();
            loadSystemStatus();
            startLiveUpdates();
            setupEventListeners();
        });

        // ç³»ç»Ÿåˆå§‹åŒ–
        function initializeSystem() {
            // è®¾ç½®æœ¬åœ°æœåŠ¡åœ°å€
            const host = window.location.hostname;
            const port = window.location.port || '8000';
            document.getElementById('localHost').textContent = host;
            document.getElementById('localPort').textContent = port;
            document.getElementById('footerHost').textContent = host;
            document.getElementById('footerPort').textContent = port;

            // åˆå§‹åŒ–æ—¥å¿—
            addLog('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
            addLog(`æœåŠ¡åœ°å€: http://${host}:${port}`, 'info');
            addLog('Puter.js å·²åŠ è½½ï¼ŒAIåŠŸèƒ½å¯ç”¨', 'info');
        }

        // åŠ è½½ç³»ç»Ÿä¿¡æ¯
        function loadSystemInfo() {
            fetch('/api/system/info')
                .then(res => res.json())
                .then(data => {
                    if (data.python_version) {
                        document.getElementById('pythonVersion').textContent = data.python_version;
                    }
                    if (data.host_name) {
                        document.getElementById('hostName').textContent = data.host_name;
                    }
                    if (data.working_dir) {
                        document.getElementById('workingDir').textContent = data.working_dir;
                    }
                    if (data.uptime) {
                        document.getElementById('uptime').textContent = data.uptime;
                    }
                    if (data.data_dir) {
                        document.getElementById('dataDir').textContent = data.data_dir;
                    }
                })
                .catch(console.error);
        }

        // åŠ è½½è´¦å·åˆ—è¡¨
        function loadAccounts() {
            fetch('/api/accounts')
                .then(res => res.json())
                .then(data => {
                    systemState.accounts = data.accounts || [];
                    updateAccountsTable();

                    // æ›´æ–°è®¡æ•°
                    document.getElementById('accountsCount').textContent = systemState.accounts.length;
                    document.getElementById('totalAccounts').textContent = systemState.accounts.length;
                    const active = systemState.accounts.filter(a => a.is_active).length;
                    document.getElementById('activeAccounts').textContent = active;
                })
                .catch(console.error);
        }

        // æ›´æ–°è´¦å·è¡¨æ ¼
        function updateAccountsTable() {
            const tbody = document.getElementById('accountsTable');
            if (systemState.accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted py-3">
                            æš‚æ— è´¦å·ï¼Œç‚¹å‡»"æ·»åŠ "æŒ‰é’®åˆ›å»º
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            systemState.accounts.slice(0, 10).forEach(account => {
                const statusClass = account.is_active ? 'success' : 'secondary';
                const statusIcon = account.is_active ? 'âœ…' : 'â¸ï¸';

                html += `
                    <tr>
                        <td>
                            <span class="badge bg-${statusClass}">${statusIcon}</span>
                        </td>
                        <td>
                            <div class="small fw-bold">${account.name || 'æœªå‘½å'}</div>
                            <div class="text-muted" style="font-size: 10px;">${account.display_name || ''}</div>
                            <div class="text-muted" style="font-size: 9px;">ç±»å‹: ${account.account_type || 'æ™®é€š'}</div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="launchBrowserForAccount(${account.id})" title="è¿æ¥ Puter è´¦å·">
                                <i class="fas fa-plug"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success mt-1" onclick="refreshAccount(${account.id})" title="åˆ·æ–°Cookie">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger mt-1" onclick="deleteAccount(${account.id})" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        function loadSystemStatus() {
            fetch('/api/system/status')
                .then(res => res.json())
                .then(data => {
                    if (data.service_status === 'running') {
                        document.getElementById('serviceStatus').className = 'badge bg-success';
                        document.getElementById('serviceStatus').textContent = 'è¿è¡Œä¸­';
                        document.getElementById('systemStatus').innerHTML = 'ğŸŸ¢ ç³»ç»Ÿè¿è¡Œæ­£å¸¸';
                    } else {
                        document.getElementById('serviceStatus').className = 'badge bg-danger';
                        document.getElementById('serviceStatus').textContent = 'åœæ­¢';
                        document.getElementById('systemStatus').innerHTML = 'ğŸ”´ ç³»ç»Ÿå¼‚å¸¸';
                    }

                    document.getElementById('apiRequestCount').textContent = data.api_requests || 0;

                    if (data.memory_usage) {
                        const memoryPercent = Math.min(100, Math.max(0, data.memory_usage));
                        document.getElementById('memoryUsage').style.width = `${memoryPercent}%`;
                        document.getElementById('memoryText').textContent = `${memoryPercent}%`;
                    }
                })
                .catch(console.error);
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            if (systemState.isLogPaused) return;

            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00bcd4',
                success: '#4caf50',
                error: '#f44336',
                warning: '#ff9800'
            };

            const logEntry = `[${timestamp}] ${message}`;
            systemState.logs.push({ timestamp, message, type });

            if (systemState.logs.length > 100) systemState.logs.shift();

            const logContainer = document.getElementById('liveLogs');
            const logLine = document.createElement('div');
            logLine.style.color = colors[type] || colors.info;
            logLine.style.marginBottom = '5px';
            logLine.textContent = logEntry;

            logContainer.appendChild(logLine);

            if (systemState.autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // å¼€å§‹å®æ—¶æ›´æ–°
        function startLiveUpdates() {
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ¯30ç§’
            setInterval(loadSystemStatus, 30000);

            // æ›´æ–°è´¦å·æ¯60ç§’
            setInterval(loadAccounts, 60000);

            // æ›´æ–°ç³»ç»Ÿä¿¡æ¯æ¯120ç§’
            setInterval(loadSystemInfo, 120000);

            // æ›´æ–°æ—¶é—´æ˜¾ç¤ºæ¯10ç§’
            setInterval(updateTime, 10000);

            updateTime();
        }

        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');
            document.getElementById('updateTime').textContent = timeStr;
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ·»åŠ è´¦å·æŒ‰é’®
            document.getElementById('addAccountBtn').addEventListener('click', function () {
                const accountName = prompt('è¯·è¾“å…¥è´¦å·åç§°:', `è´¦å·${systemState.accounts.length + 1}`);
                if (!accountName) return;

                fetch('/api/account/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: accountName,
                        display_name: accountName,
                        account_type: 'puter'
                    })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            addLog(`è´¦å·åˆ›å»ºæˆåŠŸ: ${accountName}`, 'success');
                            loadAccounts();
                        } else {
                            addLog(`è´¦å·åˆ›å»ºå¤±è´¥: ${data.message}`, 'error');
                        }
                    })
                    .catch(err => {
                        addLog(`è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
                    });
            });

            // æ‰“å¼€æµè§ˆå™¨ç™»å½•æŒ‰é’®
            document.getElementById('launchBrowserBtn').addEventListener('click', function () {
                if (systemState.accounts.length === 0) {
                    alert('è¯·å…ˆåˆ›å»ºè´¦å·');
                    return;
                }

                // ä½¿ç”¨ç¬¬ä¸€ä¸ªè´¦å·
                const account = systemState.accounts[0];
                launchBrowserForAccount(account.id);
            });

            // åˆ·æ–°æ‰€æœ‰CookieæŒ‰é’®
            document.getElementById('refreshAllBtn').addEventListener('click', function () {
                if (confirm('ç¡®å®šè¦åˆ·æ–°æ‰€æœ‰è´¦å·çš„Cookieå—ï¼Ÿ')) {
                    addLog('æ­£åœ¨åˆ·æ–°æ‰€æœ‰è´¦å·Cookie...', 'warning');
                    // å®ç°åˆ·æ–°é€»è¾‘
                }
            });

            // ä¿å­˜é…ç½®æŒ‰é’®
            document.getElementById('saveConfigBtn').addEventListener('click', function () {
                const apiKey = document.getElementById('apiKeyInput').value;
                const puterJsUrl = document.getElementById('puterJsUrl').value;

                fetch('/api/config/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([
                        { key: 'api_key', value: apiKey },
                        { key: 'puter_js_url', value: puterJsUrl }
                    ])
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            addLog('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                        } else {
                            addLog(`é…ç½®ä¿å­˜å¤±è´¥: ${data.message}`, 'error');
                        }
                    })
                    .catch(err => {
                        addLog(`è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
                    });
            });

            // ç”Ÿæˆå›¾åƒæŒ‰é’®
            document.getElementById('generateImageBtn').addEventListener('click', function () {
                const prompt = document.getElementById('imagePrompt').value;
                const model = document.getElementById('imageModel').value;
                const size = document.getElementById('imageSize').value;
                const [width, height] = size.split('x').map(Number);

                const spinner = document.getElementById('imageSpinner');
                const resultDiv = document.getElementById('imageResult');

                spinner.classList.remove('d-none');
                resultDiv.innerHTML = '';

                addLog(`æ­£åœ¨ç”Ÿæˆå›¾åƒ: ${prompt.substring(0, 50)}...`, 'info');

                // è°ƒç”¨Puter.js API
                puter.ai.txt2img(prompt, {
                    model: model,
                    width: width,
                    height: height,
                    disable_safety_checker: true
                })
                    .then(imageElement => {
                        spinner.classList.add('d-none');
                        resultDiv.innerHTML = '';
                        resultDiv.appendChild(imageElement);
                        addLog('å›¾åƒç”ŸæˆæˆåŠŸ', 'success');

                        // æ›´æ–°ç»Ÿè®¡
                        document.getElementById('requestCount').textContent = parseInt(document.getElementById('requestCount').textContent) + 1;
                        document.getElementById('successCount').textContent = parseInt(document.getElementById('successCount').textContent) + 1;
                    })
                    .catch(error => {
                        spinner.classList.add('d-none');
                        resultDiv.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
                        addLog(`å›¾åƒç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');

                        document.getElementById('requestCount').textContent = parseInt(document.getElementById('requestCount').textContent) + 1;
                        document.getElementById('errorCount').textContent = parseInt(document.getElementById('errorCount').textContent) + 1;
                    });
            });

            // å‘é€èŠå¤©æŒ‰é’®
            document.getElementById('sendChatBtn').addEventListener('click', function () {
                const message = document.getElementById('chatMessage').value;
                const model = document.getElementById('chatModel').value;
                const mode = document.getElementById('chatMode').value;
                const responseDiv = document.getElementById('chatResponse');

                responseDiv.innerHTML = 'æ­£åœ¨æ€è€ƒ...';
                addLog(`å‘é€èŠå¤©æ¶ˆæ¯: ${message.substring(0, 50)}...`, 'info');

                if (mode === 'stream') {
                    // æµå¼å“åº”
                    responseDiv.innerHTML = '';
                    puter.ai.chat(message, { model: model, stream: true })
                        .then(async response => {
                            for await (const part of response) {
                                if (part.text) {
                                    responseDiv.innerHTML += part.text.replaceAll('\n', '<br>');
                                    responseDiv.scrollTop = responseDiv.scrollHeight;
                                }
                            }
                            addLog('èŠå¤©æµå¼å“åº”å®Œæˆ', 'success');
                        })
                        .catch(error => {
                            responseDiv.innerHTML = `é”™è¯¯: ${error.message}`;
                            addLog(`èŠå¤©å¤±è´¥: ${error.message}`, 'error');
                        });
                } else {
                    // å®Œæ•´å“åº”
                    puter.ai.chat(message, { model: model, stream: false })
                        .then(response => {
                            responseDiv.innerHTML = response.text.replaceAll('\n', '<br>');
                            addLog('èŠå¤©å“åº”å®Œæˆ', 'success');
                        })
                        .catch(error => {
                            responseDiv.innerHTML = `é”™è¯¯: ${error.message}`;
                            addLog(`èŠå¤©å¤±è´¥: ${error.message}`, 'error');
                        });
                }

                document.getElementById('requestCount').textContent = parseInt(document.getElementById('requestCount').textContent) + 1;
            });

            // ç¼–è¾‘å›¾åƒæŒ‰é’®
            document.getElementById('editImageBtn').addEventListener('click', function () {
                const imageUrl = document.getElementById('editImageUrl').value;
                const prompt = document.getElementById('editPrompt').value;
                const spinner = document.getElementById('editSpinner');
                const resultDiv = document.getElementById('editResult');

                spinner.classList.remove('d-none');
                resultDiv.innerHTML = '';

                addLog(`æ­£åœ¨ç¼–è¾‘å›¾åƒ: ${prompt.substring(0, 50)}...`, 'info');

                puter.ai.txt2img(prompt, {
                    model: 'black-forest-labs/FLUX.1-kontext-pro',
                    image_url: imageUrl
                })
                    .then(imageElement => {
                        spinner.classList.add('d-none');
                        resultDiv.innerHTML = '';
                        resultDiv.appendChild(imageElement);
                        addLog('å›¾åƒç¼–è¾‘æˆåŠŸ', 'success');
                    })
                    .catch(error => {
                        spinner.classList.add('d-none');
                        resultDiv.innerHTML = `<div class="alert alert-danger">ç¼–è¾‘å¤±è´¥: ${error.message}</div>`;
                        addLog(`å›¾åƒç¼–è¾‘å¤±è´¥: ${error.message}`, 'error');
                    });
            });

            // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
            document.getElementById('clearLogsBtn').addEventListener('click', function () {
                document.getElementById('liveLogs').innerHTML = '';
                systemState.logs = [];
                addLog('æ—¥å¿—å·²æ¸…ç©º', 'warning');
            });

            // æš‚åœæ—¥å¿—æŒ‰é’®
            document.getElementById('pauseLogsBtn').addEventListener('click', function () {
                systemState.isLogPaused = !systemState.isLogPaused;
                const icon = this.querySelector('i');
                if (systemState.isLogPaused) {
                    icon.className = 'fas fa-play';
                    this.title = 'ç»§ç»­æ—¥å¿—';
                    addLog('æ—¥å¿—å·²æš‚åœ', 'warning');
                } else {
                    icon.className = 'fas fa-pause';
                    this.title = 'æš‚åœæ—¥å¿—';
                    addLog('æ—¥å¿—ç»§ç»­', 'success');
                }
            });

            // é‡å¯æœåŠ¡æŒ‰é’®
            document.getElementById('restartServiceBtn').addEventListener('click', function () {
                if (confirm('ç¡®å®šè¦é‡å¯æœåŠ¡å—ï¼Ÿé‡å¯éœ€è¦å‡ ç§’é’Ÿã€‚')) {
                    addLog('æ­£åœ¨é‡å¯æœåŠ¡...', 'warning');
                    fetch('/api/system/restart', { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                addLog('æœåŠ¡é‡å¯å‘½ä»¤å·²å‘é€', 'success');
                            } else {
                                addLog(`é‡å¯å¤±è´¥: ${data.message}`, 'error');
                            }
                        })
                        .catch(err => {
                            addLog(`è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
                        });
                }
            });
        }

        // å…¨å±€å‡½æ•°
        window.launchBrowserForAccount = async function (accountId) {
            try {
                if (typeof puter === 'undefined') {
                    alert('Puter.js æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•ï¼ˆå¯èƒ½ç”±äºç½‘ç»œåŸå› å¯¼è‡´åŠ è½½ç¼“æ…¢ï¼‰');
                    return;
                }
                addLog(`æ­£åœ¨å¯åŠ¨ Puter.js ç™»å½•æµç¨‹...`, 'info');
                const user = await puter.auth.signIn();

                addLog(`Puter ç™»å½•æˆåŠŸ: ${user.username}`, 'success');

                // å°†ç”¨æˆ·ä¿¡æ¯åŒæ­¥åˆ°åç«¯æ•°æ®åº“
                addLog(`æ­£åœ¨åŒæ­¥è´¦å·ä¿¡æ¯åˆ°åç«¯...`, 'info');
                const bindRes = await fetch(`/api/account/${accountId}/bind`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                const bindData = await bindRes.json();

                if (bindData.success) {
                    addLog(`è´¦å·åŒæ­¥æˆåŠŸ: ${bindData.account_name}`, 'success');
                    alert(`Puter è´¦å·è¿æ¥æˆåŠŸï¼\nç”¨æˆ·å: ${user.username}\nå·²åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº“ã€‚`);
                    loadAccounts(); // åˆ·æ–°åˆ—è¡¨ä»¥æ˜¾ç¤ºæ¿€æ´»çŠ¶æ€
                } else {
                    addLog(`è´¦å·åŒæ­¥è­¦å‘Š: ${bindData.message}`, 'warning');
                    alert(`ç™»å½•æˆåŠŸï¼Œä½†åŒæ­¥åˆ°åç«¯å¤±è´¥: ${bindData.message}`);
                }

            } catch (error) {
                console.error(error);
                addLog(`Puter ç™»å½•å¤±è´¥: ${error.message || error}`, 'error');
            }
        };

        window.refreshAccount = function (accountId) {
            // å®ç°åˆ·æ–°è´¦å·Cookieé€»è¾‘
            addLog('åˆ·æ–°åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        };

        window.deleteAccount = function (accountId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦å·å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚')) {
                fetch(`/api/account/${accountId}`, { method: 'DELETE' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            addLog(`è´¦å·åˆ é™¤æˆåŠŸ`, 'success');
                            loadAccounts();
                        } else {
                            addLog(`åˆ é™¤å¤±è´¥: ${data.message}`, 'error');
                        }
                    })
                    .catch(err => {
                        addLog(`è¯·æ±‚å¤±è´¥: ${err.message}`, 'error');
                    });
            }
        };
    </script>
</body>

</html>